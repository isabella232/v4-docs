"use strict";(self.webpackChunkpooltogether=self.webpackChunkpooltogether||[]).push([[614],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return h}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),s=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=s(e.components);return a.createElement(c.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,c=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),m=s(n),h=r,d=m["".concat(c,".").concat(h)]||m[h]||u[h]||i;return n?a.createElement(d,o(o({ref:t},p),{},{components:n})):a.createElement(d,o({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var s=2;s<i;s++)o[s]=n[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},7818:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return c},metadata:function(){return s},toc:function(){return p},default:function(){return m}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),o=["components"],l={title:"Time-Weighted Average Balance",position:3},c=void 0,s={unversionedId:"concepts/time-weight-average-balance",id:"concepts/time-weight-average-balance",isDocsHomePage:!1,title:"Time-Weighted Average Balance",description:"The Time-Weighted Average Balance can determine a users balance at any time in the past, or their average balance held between two times.",source:"@site/docs/concepts/time-weight-average-balance.md",sourceDirName:"concepts",slug:"/concepts/time-weight-average-balance",permalink:"/protocol/concepts/time-weight-average-balance",editUrl:"https://github.com/pooltogether/v4-docs/tree/main/docs/concepts/time-weight-average-balance.md",tags:[],version:"current",frontMatter:{title:"Time-Weighted Average Balance",position:3},sidebar:"defaultSidebar",previous:{title:"Prize Pool Network",permalink:"/protocol/concepts/prize-pools-network"},next:{title:"Tsunami",permalink:"/protocol/concepts/tsunami"}},p=[],u={toc:p};function m(e){var t=e.components,n=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"The Time-Weighted Average Balance can determine a users balance at any time in the past, or their average balance held between two times."),(0,i.kt)("p",null,"If a user held 100 tokens between Dec 20 and Dec 27, then their average balance was 100.  If instead they bought another 100 tokens halfway through, then their average should be 150."),(0,i.kt)("h1",{id:"borrowing-ideas-from-uniwap"},"Borrowing Ideas from Uniwap"),(0,i.kt)("p",null,"Uniswap"),(0,i.kt)("p",null,"Fortunately, we had some prior art we could refer to: Uniswap's Time-Weighted Average Price.  The TWAP is a running sum of a token price weighted by time.  By comparing current and past TWAPs, you can determine a token's average price for that time range."),(0,i.kt)("p",null,"The TWAP is calculated like so:"),(0,i.kt)("p",null,"Next TWAP Observation amount = Last TWAP Observation amount + current price x elapsed time since last TWAP"),(0,i.kt)("p",null,"Each TWAP Observation includes an amount and the timestamp at which it was made."),(0,i.kt)("p",null,"For example, let's say there are three trades for a Uniswap pair:"),(0,i.kt)("p",null,"Initial state: token value starts at 0\nTrade 1: Token price was 100 at time 10\nTrade 2: Token price was 200 at time 30\nTrade 3: Token price was 400 at time 50"),(0,i.kt)("p",null,"Before each trade we will create a new TWAP to record the price inflection:"),(0,i.kt)("p",null,"TWAP 1: 0 + 0 ",(0,i.kt)("em",{parentName:"p"}," 10 = 0 @ time 10\nTWAP 2: 0 + 100 ")," 20 = 2000 @ time 30\nTWAP 3: 2000 + 200 * 20 = 6000 @ time 50"),(0,i.kt)("p",null,"Now, what was the average price from time 10 to time 50?  We can calculate it like so:"),(0,i.kt)("p",null,"(delta amount) / (elapsed time)"),(0,i.kt)("p",null,"or:"),(0,i.kt)("p",null,"(TWAP amount @ 50 - TWAP amount @ 0) / (40)"),(0,i.kt)("p",null,"(6000 - 0) / 40 = 150"),(0,i.kt)("p",null,"So the average price was 150 between 0 and 40.  Given the balance was 100 for half the time, and 200 for the other half, we can confirm this easily."),(0,i.kt)("h1",{id:"time-weighted-average-balance"},"Time-Weighted Average Balance"),(0,i.kt)("p",null,"The TWAP technique can be mapped directly to token balances.  Our Time-Weighted Average Balance equation is:"),(0,i.kt)("p",null,"Next TWAB Observation amount = Last TWAB Observation amount + ",(0,i.kt)("strong",{parentName:"p"},"current balance")," x elapsed time since last TWAB"),(0,i.kt)("p",null,"Before a user's balance changes we calculate their current TWAB and append it to their history."),(0,i.kt)("p",null,"For example, let's say a user makes three transfers:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Transfers in 100 tokens @ time 10"),(0,i.kt)("li",{parentName:"ol"},"Transfers in 400 tokens @ time 20"),(0,i.kt)("li",{parentName:"ol"},"Transfers out 20 tokens @ time 30")),(0,i.kt)("p",null,"The users balance must start at zero.  We then have three TWABs:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"TWAB @ time 10: 0 + 0 * 10 = 0"),(0,i.kt)("li",{parentName:"ol"},"TWAB @ time 20: 0 + 100 * 10 = 1000"),(0,i.kt)("li",{parentName:"ol"},"TWAB @ time 30: 1000 + 500 * 10 = 6000")),(0,i.kt)("p",null,"Let's say we want to calculate the user's average balance between t = 10 and t = 30:"),(0,i.kt)("p",null,"(delta amount) / (delta time)"),(0,i.kt)("p",null,"(6000 - 0) / (30 - 10) = 6000 / 20 = 300."),(0,i.kt)("h1",{id:"twab-time-to-live"},"TWAB Time-to-live"),(0,i.kt)("p",null,"Great!  We have a way of computing a user's historic balance.  How do we store this efficiently on-chain?"))}m.isMDXComponent=!0}}]);